close all
%% 1
xcg=[0.264000,0.264000,0.3300,0.3300,0.2500,0.2500,0.2700,0.2700,0.1600,0.1600,0.2500,0.2500,0.3200,0.3200,0.07000,0.2900,0.2900,0.2500,0.2500];
Cma=[-0.6500,-0.611000,-0.137000,-0.619000,-0.2400,-0.2400,-0.668000,-0.631000,-2.08000,-1.89000,-1.06000,-1.18000,-0.6400,-0.6400,-1.30800,-0.09800,-0.7800,-1.45000,-1];
CLa=[4.41000,4.41000,4.58000,4.58000,5.500,5.500,4.81000,4.64000,6.24000,5.48000,5.38000,5.55000,5.84000,5.84000,2.00500,2.800,2.800,5.67000,4.400];
Cmq=[-15.2000,-11.4000,-26.3000,-25.1000,-17.7000,-17.7000,-14.3000,14,-34,-34,-24.7000,-22.4000,-15.5000,-15.5000,-4.83000,-2,-2,-21.4000,-20.5000];
CLq=[3.900,3.900,9.700,8.400,10,10,3.700,3.700,8.100,8.100,8,7.500,4.700,4.700,1.900,1.33000,1.300,5.65000,6.600];
Cnr=[-0.119900,-0.115100,-0.149500,-0.194700,-0.2600,-0.2600,-0.143300,-0.161300,-0.204000,-0.197000,-0.208000,-0.2000,-0.2000,-0.2000,-0.649000,-0.3200,-0.2600,-0.3600,-0.2800];
Cyr=[0.267000,0.201000,0.355000,0.355000,0.6100,0.6200,0.314000,0.263000,0.3900,0.3900,0.448000,0.448000,0.4000,0.4000,0,0,0,0,0];

for i=1:19
Xac(i)=xcg(i)-Cma(i)/CLa(i);
Xac_H(i)=xcg(i)-Cmq(i)/CLq(i);
Xac_V(i)=(xcg(i)-Cnr(i)/Cyr(i));
%Assume de/da=0
% CLawb(i)=CLa(i)-0.5*CLq(i)/(Xac_H(i)-xcg(i));
% Xac_wb(i)=xcg(i)-(Cma(i)+0.5*CLq(i))/CLawb(i);
% k(i)=Xac(i)-CLq(i)*(Xac_H(i)-Xac(i))/(Xac_H(i)-xcg(i))/CLawb(i);
syms clawb de_da xacwb
eq1=CLa(i)==clawb+0.5*(1-de_da)*CLq(i)/(Xac_H(i)-xcg(i));
eq2=Cma(i)==clawb*(xcg(i)-xacwb)-0.5*CLq(i)*(1-de_da);
eq3=Xac(i)==xacwb+0.5*(1-de_da)*CLq(i)*Xac_H(i)/(Xac_H(i)-xcg(i))/(1+0.5*(1-de_da)*CLq(i)*Xac_H(i)/(Xac_H(i)-xcg(i)));
sol=vpasolve(eq1,eq2,eq3);
Xac_wb(i)=max(double(sol.xacwb))
end

%% 2
g=32.17405;
q=[21.2000,13.6000,91.2000,22.6000,198,198,144.900,30.4000,34.2000,118.300,48.7000,91.1000,134.600,134.600,434.500,62.9000,434.500,58,287.200];
U1=[133.500,107.100,312.500,137.900,610,584,349,160,170,340,202.400,366.800,677,677,1742,230,1742,221,673];
rho=2*q./(U1.^2);
S=[174,174,175,175,136,136,182,182,280,280,340,340,230,230,196,530,530,5500,5500];
c=[4.900,4.900,4.79000,4.79000,5.400,5.400,5.47000,5.47000,6.500,6.500,6.58000,6.58000,7,7,9.600,16,16,27.3000,27.3000];
W=[2650,2650,4600,4600,4000,4000,6360,6360,11000,7000,15000,15000,13000,9000,16300,33200,39000,564000,636636];
for i=1:19
SM(i)=xcg(i)-Xac(i);
MP(i)=Xac(i)-Cmq(i)*rho(i)*S(i)*c(i)*g/(4*W(i));
end
%% 3
% load('FD2Q3.mat');
%Cdu>0
CDu=[0,0,0,0,0.05000,0.05000,0,0,0,0,0,0,0.104000,0.104000,-0.06000,0,-0.05400,0,0];
%Cyb<0
Cyb=[-0.404000,-0.303000,-0.698000,-0.577000,-1,-1,-0.361000,-0.303000,-0.5900,-0.5900,-0.886000,-0.883000,-0.7300,-0.7300,-1.04500,-0.655000,-0.7000,-1.08000,-0.9000];
%CLa>0
CLa=[4.41000,4.41000,4.58000,4.58000,5.500,5.500,4.81000,4.64000,6.24000,5.48000,5.38000,5.55000,5.84000,5.84000,2.00500,2.800,2.800,5.67000,4.400];
%Clb<0
Clb=[-0.0895000,-0.0969000,-0.109600,-0.0965000,-0.1100,-0.1100,-0.0851000,-0.0822000,-0.1300,-0.1300,-0.108000,-0.138100,-0.1100,-0.1000,-0.09300,-0.156000,-0.02500,-0.281000,-0.1600];
%Cmu>0
Cmu=[0,0,0,0,0,0,0,0,0,0,0,0,0.05000,0.07000,0,0,0.05400,0.07100,0.01300];
%Clp<0
Clp=[-0.487000,-0.494000,-0.551000,-0.566000,-0.3900,-0.3900,-0.4400,-0.458000,-0.5000,-0.5000,-0.5700,-0.566000,-0.4500,-0.4500,-0.272000,-0.272000,-0.2000,-0.502000,-0.3400];
%Cma<0
Cma=[-0.6500,-0.611000,-0.137000,-0.619000,-0.2400,-0.2400,-0.668000,-0.631000,-2.08000,-1.89000,-1.06000,-1.18000,-0.6400,-0.6400,-1.30800,-0.09800,-0.7800,-1.45000,-1];
%Cnb>0
Cnb=[0.0907000,0.0701000,0.144400,0.168300,0.1700,0.1700,0.105200,0.109500,0.1200,0.08000,0.184800,0.173900,0.127000,0.124000,0.242000,0.199000,0.09000,0.184000,0.1600];
% Cmq<0
Cmq=[-15.2000,-11.4000,-26.3000,-25.1000,-17.7000,-17.7000,-14.3000,14,-34,-34,-24.7000,-22.4000,-15.5000,-15.5000,-4.83000,-2,-2,-21.4000,-20.5000];
% Cnr<0
Cnr=[-0.119900,-0.115100,-0.149500,-0.194700,-0.2600,-0.2600,-0.143300,-0.161300,-0.204000,-0.197000,-0.208000,-0.2000,-0.2000,-0.2000,-0.649000,-0.3200,-0.2600,-0.3600,-0.2800];
% for i=1:19
%     if CDu(i)>0
%      FD2Q3.Cdu0(i)='Stable';
%     else
%      FD2Q3.Cdu0(i)='Unstable';
%     end
%     if CLa(i)>0
%      FD2Q3.CLa0(i)='Stable';
%     else
%      FD2Q3.CLa0(i)='Unstable';
%     end
%     if Cmu(i)>0
%      FD2Q3.Cmu0(i)='Stable';
%     else
%      FD2Q3.Cmu0(i)='Unstable';
%     end
%     if Cmq(i)<0
%      FD2Q3.Cmq0(i)='Stable';
%     else
%      FD2Q3.Cmq0(i)='Unstable';
%     end
%     if Cma(i)<0
%      FD2Q3.Cma0(i)='Stable';
%     else
%      FD2Q3.Cma0(i)='Unstable';
%     end
%     if Clp(i)<0
%      FD2Q3.Clp0(i)='Stable';
%     else
%      FD2Q3.Clp0(i)='Unstable';
%     end
%     if Clb(i)<0
%      FD2Q3.Clb0(i)='Stable';
%     else
%      FD2Q3.Clb0(i)='Unstable';
%     end
%     if Cnb(i)>0
%      FD2Q3.Cnb0(i)='Stable';
%     else
%      FD2Q3.Cnb0(i)='Unstable';
%     end
%     if Cyb(i)<0
%      FD2Q3.Cyb0(i)='Stable';
%     else
%      FD2Q3.Cyb0(i)='Unstable';
%     end
%     if Cnr(i)<0
%      FD2Q3.Cnr0(i)='Stable';
%     else
%      FD2Q3.Cnr0(i)='Unstable';
%     end
% end
%% 4
Cm_de=[-1.36900,-1.02900,-2.26000,-2.16000,-0.8800,-0.8200,-1.07000,-1.05000,-1.900,-2,-1.900,-1.73000,-1.24000,-1.24000,0,0,0,-1.400,-1.300];
Cm0=[0.04000,0.09000,0.07000,0.1000,-0.08000,-0.08000,0.02500,0.1000,0.1000,0.05000,0.06000,0.06000,0.05000,0.05000,-0.02800,0.02000,-0.02500,0,0];
%most aft is Xac
aH_stall=17;
%e0=0 de/da=0
de=[-15 20];
iH=0;
for i=1:19
AftCg(i)=Xac(i);
%most forward is
taw(i)=-Cm_de(i)/(0.5*CLq(i));
a1=aH_stall-iH-taw(i)*de(1);
a2=aH_stall-iH-taw(i)*de(2);
Cma1=(Cm0(i)+Cm_de(i)*de(1))/a1;
Cma2=(Cm0(i)+Cm_de(i)*de(2))/a2;
xcg1=Xac(i)+Cma1/CLa(i);
xcg2=Xac(i)+Cma2/CLa(i);
FrwCg(i)=min(xcg1,xcg2);
end

%% 5
CL_de=[0.4300,0.4300,0.8100,0.7700,0.3800,0.3500,0.4000,0.4000,0.5800,0.6000,0.6300,0.5800,0.4600,0.4600,0,0,0,0.3600,0.3200];
CL0=[0.307000,0.807000,0.288000,0.6400,0.149000,0.149000,0.1900,0.8100,0.7600,0.201000,0.4300,0.4800,0.1300,0.1300,0.122000,0.4300,0.01000,0.9200,0.2100];
de=[-15:5:20];
a=[0:0.1:15];
for i=1:19
    figure
for j=1:8
    de1=de(j);
    Cm=Cm0(i)+Cma(i).*a+Cm_de(i)*de1;
    subplot(2,1,1);
    plot(a,Cm);
    hold on
    grid on
    CL=CL0(i)+CLa(i).*a+CL_de(i)*de1;    
    subplot(2,1,2);
    plot(a,CL);
    hold on
    grid on
end


end

%% 6
CLiH=[0,0,0,0,0.9900,0.9900,0,0,1.300,1.35000,0,0,0.9400,0.9400,0.523000,0.2400,0.2500,0.7500,0.7000];
Cm_iH=[0,0,0,0,-2.300,-2.300,0,0,-3.900,-4.100,0,0,-2.500,-2.500,-1.31000,-0.322000,-0.3800,-3,-2.700];
%taw=-Cm_de/(0.5*CLq);
de=0;
%Baraye soalati ki moshtaghat iH darand sahih ast
%a=[0 10]
i=[-2 -1 0 1 2];
for j=1:19
    figure
    subplot(1,2,1);
    CL_WB=CL0(j)+CLa(j)*a;
    plot(a,CL_WB)
    hold on
    grid on
for k=1:5
    i1=i(k);
    CL_WBH=CL0(j)+CLa(j)*a+CLiH(j)*i1;
%     subplot(1,2,1);
    plot(a,CL_WBH);
    hold on
    grid on
end
    Cm0_bar(j)=Cm0(j)-Cma(j)*CL0(j)/CLa(j);
    Cm_cg_WB=Cm0_bar(j)+Cma(j)*CL_WB/CLa(j);
    subplot(1,2,2);
    plot(Cm_cg_WB,CL_WB)
    hold on
    grid on
for k=1:5
    i1=i(k);
%     CL_WBH=CL0(j)+CLa(j)*a+CLiH(j)*i1;
%     subplot(1,2,1);
%     plot(a,CL_WBH);
%     hold on
%     grid on
    Cm_cg=Cm0_bar(j)+Cm_iH(j)*i1+Cma(j)*CL_WBH/CLa(j);    
%     subplot(1,2,2);
    plot(Cm_cg,CL_WBH);
    hold on
    grid on
end
for tt=1:5
CL_af=CL0(j)+CLa(j)*(tt-1)*2+CLiH(j)*i;
Cm_cg_af=Cm0_bar(j)+Cm_iH(j)*i+Cma(j)*CL_af/CLa(j);
% subplot(1,2,2);
    plot(Cm_cg_af,CL_af);
    hold on
    grid on
end
end


% CL_WBH=CL0+CLa*a+CLiH*iH;
% Cm0_bar=Cm0-Cma*CL0/CLa;
% CmiH_bar=Cm_iH-Cma*CLiH/CLa;
% Cm_cg_WB=Cm0_bar+Cma*CL/CLa;
% Cm_cg=Cm0_bar+CmiH*iH+Cma*CL/CLa;
% Baraye tarsime khoto alpha sabet bayad bebinim ke dar har cL che iH darim
% ta Cm ra betavanim hesab konim

%% 7
%a
B=atan(0.1);
n=2;
phi1=acosd(1/n);
b=[36,36,36.9000,36.9000,26.3000,26.3000,33.8000,33.8000,46,46,55.1000,55.1000,34,34,21.9000,38.7000,38.7000,196,196];
CL1=[0.719000,1.12000,0.288000,1.16300,0.149000,0.234000,0.241000,1.15000,1.15000,0.211000,0.903000,0.484000,0.4100,0.2800,0.191000,1,0.1700,1.76000,0.4000];
Cyda=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0355000,-0.01000,0,0];
Cydr=[0.187000,0.187000,0.2300,0.2300,0.02800,0.02800,0.2000,0.2000,0.144000,0.148000,0.2000,0.2000,0.1400,0.1400,0.08700,0.124000,0.05000,0.179000,0.1200];
Clda=[0.229000,0.229000,0.172000,0.172000,0.1000,0.1000,0.178800,0.178800,0.156000,0.156000,0.177600,0.177600,0.178000,0.178000,0.0173000,0.05700,0.01500,0.05300,0.01300];
Cldr=[0.0147000,0.0147000,0.0192000,0.0192000,0.05000,0.05000,0.01500,0.01500,0.008700,0.0109000,0.02000,0.02000,0.01900,0.02100,0.007900,0.0009000,0.003000,0,0.008000];
Cnda=[-0.0504000,-0.0786000,-0.0168000,-0.0676000,-0.003000,-0.005000,-0.01600,-0.07600,-0.001200,-0.001200,-0.0367000,-0.0194000,-0.02000,-0.02000,0.002500,0.004100,-0.0009000,0.008300,0.001800];
Cndr=[-0.0805000,-0.0604000,-0.115200,-0.115200,-0.1200,-0.1200,-0.0365000,-0.0365000,-0.0763000,-0.0772000,-0.105400,-0.105400,-0.07400,-0.07400,-0.0435000,-0.07200,-0.02500,-0.113000,-0.1000];
Clr=[0.186900,0.203900,0.0729000,0.243300,0.2800,0.3100,0.05900,0.254000,0.06000,0.1400,0.217600,0.116600,0.1600,0.1400,0.154000,0.205000,0.04000,0.195000,0.1300];
Ixz=[0,0,0,0,200,200,0,0,4371,1600,0,0,1300,1400,0,1600,2200,830000,970000];
Izz=[1967,1967,11001,11001,5200,5200,11183,11183,34141,23046,64543,64543,47000,25000,60000,133700,139800,43100000,49700000];
Iyy=[1346,1346,1939,1939,4800,4800,3326,3326,20250,15148,17300,17300,18800,17800,59000,117500,122200,30500000,33100000];
Ch_de=[-0.594000,-0.594000,-0.742000,-0.742000,-0.504000,-0.504000,-0.347000,-0.347000,0,0,-0.178000,-0.212000,-0.476000,-0.476000,0,0,0,0,0];
Ch_da=[-0.369000,-0.369000,-0.453000,-0.481000,-0.5000,-0.5000,-0.226000,-0.226000,0,0,-0.462000,-0.376000,0,0,0,0,0,0,0];
Ch_dr=[0.0819000,-0.579000,-0.5900,-0.602000,-0.3800,-0.3800,-0.372000,-0.372000,0,0,-0.588000,-0.537000,0,0,0,0,0,0,0];
CL_ih=[0,0,0,0,0.9900,0.9900,0,0,1.300,1.35000,0,0,0.9400,0.9400,0.523000,0.2400,0.2500,0.7500,0.7000];
iH=0;
for i=1:19
% eq1=[B1+B da dr]==[Cyb(i) Cyda(i) Cydr(i);
%               Clb(i) Clda(i) Cldr(i);
%               Cnb(i) Cnda(i) Cndr(i)]^-1*...
%              [-Cyr(i)*b(i)*g*sind(phi1)*0.5/U1(i);
%              (Izz(i)-Iyy(i))*g^2*(sind(phi1))^3/(q(i)*S(i)*b(i)*U1(i)^2*cosd(phi1)-Clr(i)*g*b(i)*sind(phi1)*0.5/U1(i)^2);
%              (Ixz(i))*g^2*(sind(phi1))^3/(q(i)*S(i)*b(i)*U1(i)^2*cosd(phi1) -Cnr(i)*g*b(i)*sind(phi1)*0.5/U1(i)^2)];
evar=[Cyb(i) Cyda(i) Cydr(i);
              Clb(i) Clda(i) Cldr(i);
              Cnb(i) Cnda(i) Cndr(i)]^-1*...
             [-Cyr(i)*b(i)*g*sind(phi1)*0.5/U1(i)-Cyb(i)*B;
             -Clb(i)*B+(Izz(i)-Iyy(i))*g^2*(sind(phi1))^3/(q(i)*S(i)*b(i)*U1(i)^2*cosd(phi1)-Clr(i)*g*b(i)*sind(phi1)*0.5/U1(i)^2);
             -Cnb(i)*B+(Ixz(i))*g^2*(sind(phi1))^3/(q(i)*S(i)*b(i)*U1(i)^2*cosd(phi1) -Cnr(i)*g*b(i)*sind(phi1)*0.5/U1(i)^2)]
 B11(i)=evar(1);
 da1(i)=evar(2);
 dr1(i)=evar(3);
 Q1=g*(n-1/n)/U1(i);
 a1(i)=(-CL_de(i)*(Cm0(i)+Cm_iH(i)*iH+Cmq(i)*Q1*c(i)*0.5/U1(i))+Cm_de(i)*(n*CL1(i)-CL0(i)-CL_ih(i)))/(CLa(i)*Cm_de(i)-CL_de(i)*Cma(i));
 de1(i)=(-CLa(i)*(Cm0(i)+Cm_iH(i)*iH+Cmq(i)*Q1*c(i)*0.5/U1(i))-Cma(i)*(n*CL1(i)-CL0(i)-CL_ih(i)))/(CLa(i)*Cm_de(i)-CL_de(i)*Cma(i));
 
%b
%  Ch=Ch0+Cha*a+Ch_de*de;
 se=S(i)*0.1
 Ch=Ch_de(i)*de1(i);
 HM_de(i)=Ch*q(i)*se*c(i);
 Ch=Ch_da(i)*da1(i);
 HM_da(i)=Ch*q(i)*se*c(i)
 Ch=Ch_dr(i)*dr1(i);
 HM_dr(i)=Ch*q(i)*se*c(i)
end

%% 8
Ixx=[948,948,8884,8884,800,800,7985,7985,15189,10085,64811,64811,28000,6000,3600,23700,25000,13700000,18200000];
CD1=[0.05700,0.132000,0.03100,0.171000,0.02200,0.02500,0.02200,0.158000,0.162000,0.0298000,0.07500,0.04200,0.0335000,0.0279000,0.0553000,0.2000,0.04800,0.263000,0.02500];
CDa=[0.3800,0.547000,0.1600,0.6500,0.1200,0.1700,0.1300,0.682000,0.933000,0.131000,0.527000,0.269000,0.3000,0.2200,0.384000,0.555000,0.4000,1.13000,0.2000];
CD_de=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
Ctxu=[-0.171000,-0.396000,-0.09300,-0.513000,-0.05000,-0.05500,-0.05000,-0.4000,-0.324000,-0.0596000,-0.225000,-0.126000,-0.07000,-0.07000,-0.1300,-0.4500,-0.1000,-0.552300,-0.05500];
Ctx1=[0.05700,0.132000,0.03100,0.171000,0.02200,0.02500,0.02200,0.158000,0.162000,0.0298000,0.07500,0.04200,0.0335000,0.0279000,0.0553000,0.2000,0.04800,0.263000,0.02500];
CLu=[0,0,0,0,0.08400,0.132000,0,0,0.02700,0.02000,0,0,0.4000,0.2800,-0.2000,0,-0.1800,-0.2200,0.1300];
CLa_dot=[1.700,1.700,5.300,4.100,4.200,4.200,1.800,1.800,2.700,2.500,3.300,2.700,2.200,2.200,0.8200,0.6300,0.1700,6.700,7];
a1=[5.400,4,0,6.600,0,0,0.7000,4.200,3.500,0,5,0,2.700,1.500,2,11.7000,3.300,8.500,2.500];
Cm1=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
Cma_dot=[-5.57000,-5.400,-12.7000,-11.4000,-9.600,-9.600,-6.64000,-6.84000,-9.100,-9.100,-10.3000,-8.17000,-6.700,-6.700,-2.05000,-0.9500,-0.2500,-3.300,-4];
Cyp=[-0.145000,-0.213000,-0.141000,-0.289700,-0.1400,-0.1200,-0.0635000,-0.190800,-0.2100,-0.1900,-0.315000,-0.227000,0,0,0,0,0,0,0];
Cy_da=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0355000,-0.01000,0,0];
Cy_dr=[0.187000,0.187000,0.2300,0.2300,0.02800,0.02800,0.2000,0.2000,0.144000,0.148000,0.2000,0.2000,0.1400,0.1400,0.08700,0.124000,0.05000,0.179000,0.1200];
Cl_da=[0.229000,0.229000,0.172000,0.172000,0.1000,0.1000,0.178800,0.178800,0.156000,0.156000,0.177600,0.177600,0.178000,0.178000,0.0173000,0.05700,0.01500,0.05300,0.01300];
Cl_dr=[0.0147000,0.0147000,0.0192000,0.0192000,0.05000,0.05000,0.01500,0.01500,0.008700,0.0109000,0.02000,0.02000,0.01900,0.02100,0.007900,0.0009000,0.003000,0,0.008000];
Cnp=[-0.0649000,-0.09600,-0.0257000,-0.102100,0.09000,0.08000,-0.0154000,-0.0768000,-0.005000,0.01900,-0.0924000,-0.0501000,-0.008000,-0.02200,-0.09300,0.01300,0,-0.222000,-0.02600];
Cn_da=[-0.0504000,-0.0786000,-0.0168000,-0.0676000,-0.003000,-0.005000,-0.01600,-0.07600,-0.001200,-0.001200,-0.0367000,-0.0194000,-0.02000,-0.02000,0.002500,0.004100,-0.0009000,0.008300,0.001800];
Cn_dr=[-0.0805000,-0.0604000,-0.115200,-0.115200,-0.1200,-0.1200,-0.0365000,-0.0365000,-0.0763000,-0.0772000,-0.105400,-0.105400,-0.07400,-0.07400,-0.0435000,-0.07200,-0.02500,-0.113000,-0.1000];
Cntb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
Cmtu=[0,0,0,0,0,0,0,0,0,0,0,0,-0.003000,-0.003000,0,0,0,0,0];
Cmt1=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
% inputs
for i=1:19
m(i)=W(i)/g;
% X
Xu(i)= -q(i)*S(i)*(CDu(i)+CD1(i))/(m(i)*U1(i));
Xa(i)= -q(i)*S(i)*(CDa(i)+CL1(i))/(m(i)*U1(i));
X_de(i)= -q(i)*S(i)*(CD_de(i))/(m(i));
Xtu(i)=-q(i)*S(i)*(Ctxu(i)+Ctx1(i))/(m(i)*U1(i));
% Z
Zu(i)= -q(i)*S(i)*(CLu(i)+CL1(i))/(m(i)*U1(i));
Za(i)= -q(i)*S(i)*(CLa(i)+CD1(i))/(m(i)*U1(i));
Z_de(i)= -q(i)*S(i)*(CL_de(i))/(m(i));
Zq(i)=-q(i)*S(i)*c(i)*(CLq(i))/(2*m(i)*U1(i));
Za_dot(i)=-q(i)*S(i)*c(i)*(CLa_dot(i))/(2*m(i)*U1(i));
% M
Mu(i)= q(i)*S(i)*c(i)*(Cmu(i)+2*Cm1(i))/(2*Iyy(i)*U1(i));
Ma(i)= q(i)*S(i)*c(i)*(Cma(i))/(Iyy(i));
M_de(i)= q(i)*S(i)*c(i)*(Cm_de(i))/(Iyy(i));
Mq(i)= q(i)*S(i)*c(i)^2*(Cmq(i))/(2*Iyy(i)*U1(i));
Ma_dot(i)=q(i)*S(i)*c(i)^2*(Cma_dot(i))/(2*Iyy(i)*U1(i));
Mtu(i)=q(i)*S(i)*c(i)*(Cmtu(i)+2*Cmt1(i))/(Iyy(i)*U1(i));
%
A11=[cosd(a1(i))^2 sind(a1(i))^2 -sind(2*a1(i));
     sind(a1(i))^2 cosd(a1(i))^2 sind(2*a1(i));
     0.5*sind(2*a1(i)) -0.5*sind(2*a1(i)) cosd(2*a1(i))]*[Ixx(i);Izz(i);Ixz(i)];
Ixx(i)=A11(1);Izz(i)=A11(2);Ixz(i)=A11(3);
% Y
Yb(i)= q(i)*S(i)*(Cyb(i))/(m(i));
Yr(i)= q(i)*S(i)*b(i)*(Cyr(i))/(2*m(i)*U1(i));
Yp(i)= q(i)*S(i)*b(i)*(Cyp(i))/(2*m(i)*U1(i));
Y_da(i)= q(i)*S(i)*(Cy_da(i))/(m(i));
Y_dr(i)= q(i)*S(i)*(Cy_dr(i))/(m(i));
% L
Lb(i)= q(i)*S(i)*b(i)*(Clb(i))/(Ixx(i));
Lr(i)= q(i)*S(i)*b(i)^2*(Clr(i))/(2*Ixx(i)*U1(i));
Lp(i)= q(i)*S(i)*b(i)^2*(Clp(i))/(2*Ixx(i)*U1(i));
L_da(i)= q(i)*S(i)*b(i)*(Cl_da(i))/(Ixx(i));
L_dr(i)= q(i)*S(i)*b(i)*(Cl_dr(i))/(Ixx(i));
% N
Nb(i)= q(i)*S(i)*b(i)*(Cnb(i))/(Izz(i));
Nr(i)= q(i)*S(i)*b(i)^2*(Cnr(i))/(2*Izz(i)*U1(i));
Np(i)= q(i)*S(i)*b(i)^2*(Cnp(i))/(2*Izz(i)*U1(i));
N_da(i)= q(i)*S(i)*b(i)*(Cn_da(i))/(Izz(i));
N_dr(i)= q(i)*S(i)*b(i)*(Cn_dr(i))/(Izz(i));
Ntb(i)= q(i)*S(i)*b(i)*(Cntb(i))/(Izz(i));
A1(i)=Ixz(i)/Ixx(i);B1(i)=Ixz(i)/Izz(i);
% Calculations
%Approximations
%Short Period
wn_sp(i)=sqrt(Za(i)*Mq(i)/U1(i)-Ma(i));
zita_sp(i)=-(Mq(i)+Za(i)/U1(i)+Ma_dot(i))/(2*wn_sp(i));
%Phugoid
wn_ph(i)=sqrt(-g*Zu(i)/U1(i));
%wn_ph=g*sqrt(2)/U1;
% zita_ph=-Xu/(2*wn_ph);
zita_ph(i)=sqrt(2)*(CDu(i)-Ctxu(i))/(4*CL1(i));
%zita_ph=sqrt(2)/(2*CL1/CD1)
%Dutch Roll
wn_d(i)=sqrt(Nb(i)+(Yb(i)*Nr(i)-Nb(i)*Yr(i))/U1(i));
zita_d(i)=-(Nr(i)+Yb(i)/U1(i))/(2*wn_d(i));
% Spiral
pole=(Lb(i)*Nr(i)-Nb(i)*Lr(i))/(Lb(i)+Nb(i)*A1(i));
T_s(i)=-1/pole;
% Roll
T_r(i)=-1/Lp(i);
syms s
theta1=0;
%Longitudinal
A=[(s-Xu(i)-Xtu(i)) -Xa(i) g*cosd(theta1);
   -Zu(i) s*(U1(i)-Za_dot(i))-Za(i) -(Zq(i)+U1(i))*s+g*sind(theta1);
   -(Mu(i)+Mtu(i)) -(Ma_dot(i)*s+Ma(i)) s^2-Mq(i)*s];
D=det(A);
roots_Long=root(D)
% Lateral Directional
A=[s*U1(i)-Yb(i) -(g*cosd(theta1)+s*Yp(i)) s*(U1(i)-Yr(i));
   -Lb(i) s^2-Lp(i)*s -(s^2*A1(i)+s*Lr(i));
   -(Nb(i)+Ntb(i)) -(s^2*B1(i)+Np(i)*s) s^2-Nr(i)*s]
D=det(A);
roots_Lat=double(root(D))
 wn=double(norm(roots_Lat))
 zita=-double(cos(angle(roots_Lat)))

end

%% 9
% Calculations
%Longitudinal
syms s
for i=1:19
A=[(s-Xu(i)-Xtu(i)) -Xa(i) g*cosd(theta1);
   -Zu(i) s*(U1(i)-Za_dot(i))-Za(i) -(Zq(i)+U1(i))*s+g*sind(theta1);
   -(Mu(i)+Mtu(i)) -(Ma_dot(i)*s+Ma(i)) s^2-Mq(i)*s];
B=[X_de(i) Z_de(i) M_de(i)]';
TrnferFcn_Long=(A^-1)*B%TrnferFcn=[u/de a/de theta/de]'
% Lateral Directional
A=[s*U1(i)-Yb(i) -(g*cosd(theta1)+s*Yp(i)) s*(U1(i)-Yr(i));
   -Lb(i) s^2-Lp(i)*s -(s^2*A1(i)+s*Lr(i));
   -(Nb(i)+Ntb(i)) -(s^2*B1(i)+Np(i)*s) s^2-Nr(i)*s];
B=[Y_da(i) L_da(i) N_da(i)]';
%B=[Y_dr L_dr N_dr]';
TrnferFcn_Lat=(A^-1)*B%TrnferFcn=[b/di phi/di psi/di]'

end

%% 10
% mode phugoid ra ba SAS nemitavn taghier dad
%Find Nr_Desired for Spiral and Dutch Roll
% pole=(Lb(i)*Nr(i)-Nb(i)*Lr(i))/(Lb(i)+Nb(i)*A1(i));
% T_s(i)=-1/pole;
for i=1:19
Nr_Desired3(i)=-1.1*zita_d(i)*2*wn_d(i)*U1(i)-Yb(i);
Nr_Desired2(i)=(((Lb(i)+Nb(i)*A1(i))/(-1.4*T_s(i)))+Nb(i)*Lr(i))/Lb(i);
k2(i)=Nr_Desired2(i)-Nr(i)/N_dr(i);
k3(i)=Nr_Desired3(i)-Nr(i)/N_dr(i);
end
