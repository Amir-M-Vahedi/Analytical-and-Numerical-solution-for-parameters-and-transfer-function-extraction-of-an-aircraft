close all
i=18 % The index of the desired Aircraft
%% 1
xcg=[0.264000000000000,0.264000000000000,0.330000000000000,0.330000000000000,0.250000000000000,0.250000000000000,0.270000000000000,0.270000000000000,0.160000000000000,0.160000000000000,0.250000000000000,0.250000000000000,0.320000000000000,0.320000000000000,0.0700000000000000,0.290000000000000,0.290000000000000,0.250000000000000,0.250000000000000];
Cma=[-0.650000000000000,-0.611000000000000,-0.137000000000000,-0.619000000000000,-0.240000000000000,-0.240000000000000,-0.668000000000000,-0.631000000000000,-2.08000000000000,-1.89000000000000,-1.06000000000000,-1.18000000000000,-0.640000000000000,-0.640000000000000,-1.30800000000000,-0.0980000000000000,-0.780000000000000,-1.45000000000000,-1];
CLa=[4.41000000000000,4.41000000000000,4.58000000000000,4.58000000000000,5.50000000000000,5.50000000000000,4.81000000000000,4.64000000000000,6.24000000000000,5.48000000000000,5.38000000000000,5.55000000000000,5.84000000000000,5.84000000000000,2.00500000000000,2.80000000000000,2.80000000000000,5.67000000000000,4.40000000000000];
Cmq=[-15.2000000000000,-11.4000000000000,-26.3000000000000,-25.1000000000000,-17.7000000000000,-17.7000000000000,-14.3000000000000,14,-34,-34,-24.7000000000000,-22.4000000000000,-15.5000000000000,-15.5000000000000,-4.83000000000000,-2,-2,-21.4000000000000,-20.5000000000000];
CLq=[3.90000000000000,3.90000000000000,9.70000000000000,8.40000000000000,10,10,3.70000000000000,3.70000000000000,8.10000000000000,8.10000000000000,8,7.50000000000000,4.70000000000000,4.70000000000000,1.90000000000000,1.33000000000000,1.30000000000000,5.65000000000000,6.60000000000000];
Cnr=[-0.119900000000000,-0.115100000000000,-0.149500000000000,-0.194700000000000,-0.260000000000000,-0.260000000000000,-0.143300000000000,-0.161300000000000,-0.204000000000000,-0.197000000000000,-0.208000000000000,-0.200000000000000,-0.200000000000000,-0.200000000000000,-0.649000000000000,-0.320000000000000,-0.260000000000000,-0.360000000000000,-0.280000000000000];
Cyr=[0.267000000000000,0.201000000000000,0.355000000000000,0.355000000000000,0.610000000000000,0.620000000000000,0.314000000000000,0.263000000000000,0.390000000000000,0.390000000000000,0.448000000000000,0.448000000000000,0.400000000000000,0.400000000000000,0,0,0,0,0];
c=[4.90000000000000,4.90000000000000,4.79000000000000,4.79000000000000,5.40000000000000,5.40000000000000,5.47000000000000,5.47000000000000,6.50000000000000,6.50000000000000,6.58000000000000,6.58000000000000,7,7,9.60000000000000,16,16,27.3000000000000,27.3000000000000];
b=[36,36,36.9000000000000,36.9000000000000,26.3000000000000,26.3000000000000,33.8000000000000,33.8000000000000,46,46,55.1000000000000,55.1000000000000,34,34,21.9000000000000,38.7000000000000,38.7000000000000,196,196];


 Cyr(i)=0.25;
Xac=xcg(i)-Cma(i)/CLa(i);
Xac_H=xcg(i)-Cmq(i)/CLq(i);
Xac_V=(xcg(i)*c(i)/b(i)-Cnr(i)/Cyr(i));
%Assume de/da=0
% CLawb(i)=CLa(i)-0.5*CLq(i)/(Xac_H(i)-xcg(i));
% Xac_wb(i)=xcg(i)-(Cma(i)+0.5*CLq(i))/CLawb(i);
% k(i)=Xac(i)-CLq(i)*(Xac_H(i)-Xac(i))/(Xac_H(i)-xcg(i))/CLawb(i);
syms clawb de_da xacwb
eq1=CLa(i)==clawb+0.5*(1-de_da)*CLq(i)/(Xac_H-xcg(i));
eq2=Cma(i)==clawb*(xcg(i)-xacwb)-0.5*CLq(i)*(1-de_da);
eq3=Xac==xacwb+0.5*(1-de_da)*CLq(i)*Xac_H/(Xac_H-xcg(i))/(1+0.5*(1-de_da)*CLq(i)*Xac_H/(Xac_H-xcg(i)));
sol=vpasolve(eq1,eq2,eq3);
Xac_wb=max(double(sol.xacwb))


%% 2
g=32.17405;
q=[21.2000000000000,13.6000000000000,91.2000000000000,22.6000000000000,198,198,144.900000000000,30.4000000000000,34.2000000000000,118.300000000000,48.7000000000000,91.1000000000000,134.600000000000,134.600000000000,434.500000000000,62.9000000000000,434.500000000000,58,287.200000000000];
U1=[133.500000000000,107.100000000000,312.500000000000,137.900000000000,610,584,349,160,170,340,202.400000000000,366.800000000000,677,677,1742,230,1742,221,673];
rho=2*q./(U1.^2);
S=[174,174,175,175,136,136,182,182,280,280,340,340,230,230,196,530,530,5500,5500];
W=[2650,2650,4600,4600,4000,4000,6360,6360,11000,7000,15000,15000,13000,9000,16300,33200,39000,564000,636636];

SM=xcg(i)-Xac;
MP=Xac-Cmq(i)*rho(i)*S(i)*c(i)*g/(4*W(i));

%% 3
% load('FD2Q3.mat');
%Cdu>0
CDu=[0,0,0,0,0.0500000000000000,0.0500000000000000,0,0,0,0,0,0,0.104000000000000,0.104000000000000,-0.0600000000000000,0,-0.0540000000000000,0,0];
%Cyb<0
Cyb=[-0.404000000000000,-0.303000000000000,-0.698000000000000,-0.577000000000000,-1,-1,-0.361000000000000,-0.303000000000000,-0.590000000000000,-0.590000000000000,-0.886000000000000,-0.883000000000000,-0.730000000000000,-0.730000000000000,-1.04500000000000,-0.655000000000000,-0.700000000000000,-1.08000000000000,-0.900000000000000];
%CLa>0
CLa=[4.41000000000000,4.41000000000000,4.58000000000000,4.58000000000000,5.50000000000000,5.50000000000000,4.81000000000000,4.64000000000000,6.24000000000000,5.48000000000000,5.38000000000000,5.55000000000000,5.84000000000000,5.84000000000000,2.00500000000000,2.80000000000000,2.80000000000000,5.67000000000000,4.40000000000000];
%Clb<0
Clb=[-0.0895000000000000,-0.0969000000000000,-0.109600000000000,-0.0965000000000000,-0.110000000000000,-0.110000000000000,-0.0851000000000000,-0.0822000000000000,-0.130000000000000,-0.130000000000000,-0.108000000000000,-0.138100000000000,-0.110000000000000,-0.100000000000000,-0.0930000000000000,-0.156000000000000,-0.0250000000000000,-0.281000000000000,-0.160000000000000];
%Cmu>0
Cmu=[0,0,0,0,0,0,0,0,0,0,0,0,0.0500000000000000,0.0700000000000000,0,0,0.0540000000000000,0.0710000000000000,0.0130000000000000];
%Clp<0
Clp=[-0.487000000000000,-0.494000000000000,-0.551000000000000,-0.566000000000000,-0.390000000000000,-0.390000000000000,-0.440000000000000,-0.458000000000000,-0.500000000000000,-0.500000000000000,-0.570000000000000,-0.566000000000000,-0.450000000000000,-0.450000000000000,-0.272000000000000,-0.272000000000000,-0.200000000000000,-0.502000000000000,-0.340000000000000];
%Cma<0
Cma=[-0.650000000000000,-0.611000000000000,-0.137000000000000,-0.619000000000000,-0.240000000000000,-0.240000000000000,-0.668000000000000,-0.631000000000000,-2.08000000000000,-1.89000000000000,-1.06000000000000,-1.18000000000000,-0.640000000000000,-0.640000000000000,-1.30800000000000,-0.0980000000000000,-0.780000000000000,-1.45000000000000,-1];
%Cnb>0
Cnb=[0.0907000000000000,0.0701000000000000,0.144400000000000,0.168300000000000,0.170000000000000,0.170000000000000,0.105200000000000,0.109500000000000,0.120000000000000,0.0800000000000000,0.184800000000000,0.173900000000000,0.127000000000000,0.124000000000000,0.242000000000000,0.199000000000000,0.0900000000000000,0.184000000000000,0.160000000000000];
% Cmq<0
Cmq=[-15.2000000000000,-11.4000000000000,-26.3000000000000,-25.1000000000000,-17.7000000000000,-17.7000000000000,-14.3000000000000,14,-34,-34,-24.7000000000000,-22.4000000000000,-15.5000000000000,-15.5000000000000,-4.83000000000000,-2,-2,-21.4000000000000,-20.5000000000000];
% Cnr<0
Cnr=[-0.119900000000000,-0.115100000000000,-0.149500000000000,-0.194700000000000,-0.260000000000000,-0.260000000000000,-0.143300000000000,-0.161300000000000,-0.204000000000000,-0.197000000000000,-0.208000000000000,-0.200000000000000,-0.200000000000000,-0.200000000000000,-0.649000000000000,-0.320000000000000,-0.260000000000000,-0.360000000000000,-0.280000000000000];

%     if CDu(i)>0
%      FD2Q3.Cdu0(i)='Stable';
%     else
%      FD2Q3.Cdu0(i)='Unstable';
%     end
%     if CLa(i)>0
%      FD2Q3.CLa0(i)='Stable';
%     else
%      FD2Q3.CLa0(i)='Unstable';
%     end
%     if Cmu(i)>0
%      FD2Q3.Cmu0(i)='Stable';
%     else
%      FD2Q3.Cmu0(i)='Unstable';
%     end
%     if Cmq(i)<0
%      FD2Q3.Cmq0(i)='Stable';
%     else
%      FD2Q3.Cmq0(i)='Unstable';
%     end
%     if Cma(i)<0
%      FD2Q3.Cma0(i)='Stable';
%     else
%      FD2Q3.Cma0(i)='Unstable';
%     end
%     if Clp(i)<0
%      FD2Q3.Clp0(i)='Stable';
%     else
%      FD2Q3.Clp0(i)='Unstable';
%     end
%     if Clb(i)<0
%      FD2Q3.Clb0(i)='Stable';
%     else
%      FD2Q3.Clb0(i)='Unstable';
%     end
%     if Cnb(i)>0
%      FD2Q3.Cnb0(i)='Stable';
%     else
%      FD2Q3.Cnb0(i)='Unstable';
%     end
%     if Cyb(i)<0
%      FD2Q3.Cyb0(i)='Stable';
%     else
%      FD2Q3.Cyb0(i)='Unstable';
%     end
%     if Cnr(i)<0
%      FD2Q3.Cnr0(i)='Stable';
%     else
%      FD2Q3.Cnr0(i)='Unstable';
%     end

%% 4
Cm_de=[-1.36900000000000,-1.02900000000000,-2.26000000000000,-2.16000000000000,-0.880000000000000,-0.820000000000000,-1.07000000000000,-1.05000000000000,-1.90000000000000,-2,-1.90000000000000,-1.73000000000000,-1.24000000000000,-1.24000000000000,0,0,0,-1.40000000000000,-1.30000000000000];
Cm0=[0.0400000000000000,0.0900000000000000,0.0700000000000000,0.100000000000000,-0.0800000000000000,-0.0800000000000000,0.0250000000000000,0.100000000000000,0.100000000000000,0.0500000000000000,0.0600000000000000,0.0600000000000000,0.0500000000000000,0.0500000000000000,-0.0280000000000000,0.0200000000000000,-0.0250000000000000,0,0];
%most aft is Xac
aH_stall=17;
%e0=0 de/da=0
de=[-15 20];
iH=0;
AftCg=Xac;
%most forward is
taw=-Cm_de(i)/(0.5*CLq(i));
a1=aH_stall-iH-taw*de(1);
a2=aH_stall-iH-taw*de(2);
Cma1=(Cm0(i)+Cm_de(i)*de(1))/a1;
Cma2=(Cm0(i)+Cm_de(i)*de(2))/a2;
xcg1=Xac+Cma1/CLa(i);
xcg2=Xac+Cma2/CLa(i);
FrwCg=min(xcg1,xcg2);


%% 5
CL_de=[0.430000000000000,0.430000000000000,0.810000000000000,0.770000000000000,0.380000000000000,0.350000000000000,0.400000000000000,0.400000000000000,0.580000000000000,0.600000000000000,0.630000000000000,0.580000000000000,0.460000000000000,0.460000000000000,0,0,0,0.360000000000000,0.320000000000000];
CL0=[0.307000000000000,0.807000000000000,0.288000000000000,0.640000000000000,0.149000000000000,0.149000000000000,0.190000000000000,0.810000000000000,0.760000000000000,0.201000000000000,0.430000000000000,0.480000000000000,0.130000000000000,0.130000000000000,0.122000000000000,0.430000000000000,0.0100000000000000,0.920000000000000,0.210000000000000];
de=[-15:5:20];
a=[0:0.1:15];
    figure
for j=1:8
    de1=de(j);
    Cm=Cm0(i)+Cma(i).*a+Cm_de(i)*de1;
    subplot(2,1,1);
    plot(a,Cm);
    hold on
    grid on
    legends{j} = sprintf('de= %d', de1);
end
yline(0,'-.k')
hold off
legend(legends)
ylabel('Cm');
   for j=1:8 
    de1=de(j);
    CL=CL0(i)+CLa(i).*a+CL_de(i)*de1;    
    subplot(2,1,2);
    plot(a,CL);
    hold on
    grid on
    legends{j} = sprintf('de= %d', de1);
end
    legend(legends)
ylabel('CL');
xlabel('Alpha(Deg)');



%% 6
CLiH=[0,0,0,0,0.990000000000000,0.990000000000000,0,0,1.30000000000000,1.35000000000000,0,0,0.940000000000000,0.940000000000000,0.523000000000000,0.240000000000000,0.250000000000000,0.750000000000000,0.700000000000000];
Cm_iH=[0,0,0,0,-2.30000000000000,-2.30000000000000,0,0,-3.90000000000000,-4.10000000000000,0,0,-2.50000000000000,-2.50000000000000,-1.31000000000000,-0.322000000000000,-0.380000000000000,-3,-2.70000000000000];
%taw=-Cm_de/(0.5*CLq);
de=0;
%Baraye soalati ki moshtaghat iH darand sahih ast
%a=[0 10]
i=[-2 -1 0 1 2];
j=18
    figure
    subplot(1,2,1);
    CL_WB=CL0(j)+CLa(j)*a;
    plot(a,CL_WB)
    hold on
    grid on
for k=1:5
    i1=i(k);
    CL_WBH=CL0(j)+CLa(j)*a+CLiH(j)*i1;
%     subplot(1,2,1);
    plot(a,CL_WBH);
    hold on
    grid on
end
    Cm0_bar=Cm0(j)-Cma(j)*CL0(j)/CLa(j);
    Cm_cg_WB=Cm0_bar+Cma(j)*CL_WB/CLa(j);
    subplot(1,2,2);
    plot(Cm_cg_WB,CL_WB)
    hold on
    grid on
for k=1:5
    i1=i(k);
%     CL_WBH=CL0(j)+CLa(j)*a+CLiH(j)*i1;
%     subplot(1,2,1);
%     plot(a,CL_WBH);
%     hold on
%     grid on
    Cm_cg=Cm0_bar+Cm_iH(j)*i1+Cma(j)*CL_WBH/CLa(j);    
%     subplot(1,2,2);
    plot(Cm_cg,CL_WBH);
    hold on
    grid on
end
for tt=1:5
CL_af=CL0(j)+CLa(j)*(tt-1)*2+CLiH(j)*i;
Cm_cg_af=Cm0_bar+Cm_iH(j)*i+Cma(j)*CL_af/CLa(j);
% subplot(1,2,2);
    plot(Cm_cg_af,CL_af);
    hold on
    grid on
end



% CL_WBH=CL0+CLa*a+CLiH*iH;
% Cm0_bar=Cm0-Cma*CL0/CLa;
% CmiH_bar=Cm_iH-Cma*CLiH/CLa;
% Cm_cg_WB=Cm0_bar+Cma*CL/CLa;
% Cm_cg=Cm0_bar+CmiH*iH+Cma*CL/CLa;
% Baraye tarsime khoto alpha sabet bayad bebinim ke dar har cL che iH darim
% ta Cm ra betavanim hesab konim

%% 7
%a
i=18
B=atan(0.1);
n=2;
phi1=acosd(1/n);
CL1=[0.719000000000000,1.12000000000000,0.288000000000000,1.16300000000000,0.149000000000000,0.234000000000000,0.241000000000000,1.15000000000000,1.15000000000000,0.211000000000000,0.903000000000000,0.484000000000000,0.410000000000000,0.280000000000000,0.191000000000000,1,0.170000000000000,1.76000000000000,0.400000000000000];
Cyda=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0355000000000000,-0.0100000000000000,0,0];
Cydr=[0.187000000000000,0.187000000000000,0.230000000000000,0.230000000000000,0.0280000000000000,0.0280000000000000,0.200000000000000,0.200000000000000,0.144000000000000,0.148000000000000,0.200000000000000,0.200000000000000,0.140000000000000,0.140000000000000,0.0870000000000000,0.124000000000000,0.0500000000000000,0.179000000000000,0.120000000000000];
Clda=[0.229000000000000,0.229000000000000,0.172000000000000,0.172000000000000,0.100000000000000,0.100000000000000,0.178800000000000,0.178800000000000,0.156000000000000,0.156000000000000,0.177600000000000,0.177600000000000,0.178000000000000,0.178000000000000,0.0173000000000000,0.0570000000000000,0.0150000000000000,0.0530000000000000,0.0130000000000000];
Cldr=[0.0147000000000000,0.0147000000000000,0.0192000000000000,0.0192000000000000,0.0500000000000000,0.0500000000000000,0.0150000000000000,0.0150000000000000,0.00870000000000000,0.0109000000000000,0.0200000000000000,0.0200000000000000,0.0190000000000000,0.0210000000000000,0.00790000000000000,0.000900000000000000,0.00300000000000000,0,0.00800000000000000];
Cnda=[-0.0504000000000000,-0.0786000000000000,-0.0168000000000000,-0.0676000000000000,-0.00300000000000000,-0.00500000000000000,-0.0160000000000000,-0.0760000000000000,-0.00120000000000000,-0.00120000000000000,-0.0367000000000000,-0.0194000000000000,-0.0200000000000000,-0.0200000000000000,0.00250000000000000,0.00410000000000000,-0.000900000000000000,0.00830000000000000,0.00180000000000000];
Cndr=[-0.0805000000000000,-0.0604000000000000,-0.115200000000000,-0.115200000000000,-0.120000000000000,-0.120000000000000,-0.0365000000000000,-0.0365000000000000,-0.0763000000000000,-0.0772000000000000,-0.105400000000000,-0.105400000000000,-0.0740000000000000,-0.0740000000000000,-0.0435000000000000,-0.0720000000000000,-0.0250000000000000,-0.113000000000000,-0.100000000000000];
Clr=[0.186900000000000,0.203900000000000,0.0729000000000000,0.243300000000000,0.280000000000000,0.310000000000000,0.0590000000000000,0.254000000000000,0.0600000000000000,0.140000000000000,0.217600000000000,0.116600000000000,0.160000000000000,0.140000000000000,0.154000000000000,0.205000000000000,0.0400000000000000,0.195000000000000,0.130000000000000];
Ixz=[0,0,0,0,200,200,0,0,4371,1600,0,0,1300,1400,0,1600,2200,830000,970000];
Izz=[1967,1967,11001,11001,5200,5200,11183,11183,34141,23046,64543,64543,47000,25000,60000,133700,139800,43100000,49700000];
Iyy=[1346,1346,1939,1939,4800,4800,3326,3326,20250,15148,17300,17300,18800,17800,59000,117500,122200,30500000,33100000];
Ch_de=[-0.594000000000000,-0.594000000000000,-0.742000000000000,-0.742000000000000,-0.504000000000000,-0.504000000000000,-0.347000000000000,-0.347000000000000,0,0,-0.178000000000000,-0.212000000000000,-0.476000000000000,-0.476000000000000,0,0,0,0,0];
Ch_da=[-0.369000000000000,-0.369000000000000,-0.453000000000000,-0.481000000000000,-0.500000000000000,-0.500000000000000,-0.226000000000000,-0.226000000000000,0,0,-0.462000000000000,-0.376000000000000,0,0,0,0,0,0,0];
Ch_dr=[0.0819000000000000,-0.579000000000000,-0.590000000000000,-0.602000000000000,-0.380000000000000,-0.380000000000000,-0.372000000000000,-0.372000000000000,0,0,-0.588000000000000,-0.537000000000000,0,0,0,0,0,0,0];
CL_ih=[0,0,0,0,0.990000000000000,0.990000000000000,0,0,1.30000000000000,1.35000000000000,0,0,0.940000000000000,0.940000000000000,0.523000000000000,0.240000000000000,0.250000000000000,0.750000000000000,0.700000000000000];
iH=0;

% eq1=[B1+B da dr]==[Cyb(i) Cyda(i) Cydr(i);
%               Clb(i) Clda(i) Cldr(i);
%               Cnb(i) Cnda(i) Cndr(i)]^-1*...
%              [-Cyr(i)*b(i)*g*sind(phi1)*0.5/U1(i);
%              (Izz(i)-Iyy(i))*g^2*(sind(phi1))^3/(q(i)*S(i)*b(i)*U1(i)^2*cosd(phi1)-Clr(i)*g*b(i)*sind(phi1)*0.5/U1(i)^2);
%              (Ixz(i))*g^2*(sind(phi1))^3/(q(i)*S(i)*b(i)*U1(i)^2*cosd(phi1) -Cnr(i)*g*b(i)*sind(phi1)*0.5/U1(i)^2)];
evar=[Cyb(i) Cyda(i) Cydr(i);
              Clb(i) Clda(i) Cldr(i);
              Cnb(i) Cnda(i) Cndr(i)]^-1*...
             [-Cyr(i)*b(i)*g*sind(phi1)*0.5/U1(i)-Cyb(i)*B;
             -Clb(i)*B+(Izz(i)-Iyy(i))*g^2*(sind(phi1))^3/(q(i)*S(i)*b(i)*U1(i)^2*cosd(phi1)-Clr(i)*g*b(i)*sind(phi1)*0.5/U1(i)^2);
             -Cnb(i)*B+(Ixz(i))*g^2*(sind(phi1))^3/(q(i)*S(i)*b(i)*U1(i)^2*cosd(phi1) -Cnr(i)*g*b(i)*sind(phi1)*0.5/U1(i)^2)]
 B11=evar(1);
 da1=evar(2);
 dr1=evar(3);
 Q1=g*(n-1/n)/U1(i);
 a1=(-CL_de(i)*(Cm0(i)+Cm_iH(i)*iH+Cmq(i)*Q1*c(i)*0.5/U1(i))+Cm_de(i)*(n*CL1(i)-CL0(i)-CL_ih(i)))/(CLa(i)*Cm_de(i)-CL_de(i)*Cma(i));
 de1=(-CLa(i)*(Cm0(i)+Cm_iH(i)*iH+Cmq(i)*Q1*c(i)*0.5/U1(i))-Cma(i)*(n*CL1(i)-CL0(i)-CL_ih(i)))/(CLa(i)*Cm_de(i)-CL_de(i)*Cma(i));
 
%b
%  Ch=Ch0+Cha*a+Ch_de*de;
 se=S(i)*0.1
 Ch=Ch_de(i)*de1;
 HM_de=Ch*q(i)*se*c(i);
 Ch=Ch_da(i)*da1;
 HM_da=Ch*q(i)*se*c(i)
 Ch=Ch_dr(i)*dr1;
 HM_dr=Ch*q(i)*se*c(i)


%% 8
Ixx=[948,948,8884,8884,800,800,7985,7985,15189,10085,64811,64811,28000,6000,3600,23700,25000,13700000,18200000];
CD1=[0.0570000000000000,0.132000000000000,0.0310000000000000,0.171000000000000,0.0220000000000000,0.0250000000000000,0.0220000000000000,0.158000000000000,0.162000000000000,0.0298000000000000,0.0750000000000000,0.0420000000000000,0.0335000000000000,0.0279000000000000,0.0553000000000000,0.200000000000000,0.0480000000000000,0.263000000000000,0.0250000000000000];
CDa=[0.380000000000000,0.547000000000000,0.160000000000000,0.650000000000000,0.120000000000000,0.170000000000000,0.130000000000000,0.682000000000000,0.933000000000000,0.131000000000000,0.527000000000000,0.269000000000000,0.300000000000000,0.220000000000000,0.384000000000000,0.555000000000000,0.400000000000000,1.13000000000000,0.200000000000000];
CD_de=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
Ctxu=[-0.171000000000000,-0.396000000000000,-0.0930000000000000,-0.513000000000000,-0.0500000000000000,-0.0550000000000000,-0.0500000000000000,-0.400000000000000,-0.324000000000000,-0.0596000000000000,-0.225000000000000,-0.126000000000000,-0.0700000000000000,-0.0700000000000000,-0.130000000000000,-0.450000000000000,-0.100000000000000,-0.552300000000000,-0.0550000000000000];
Ctx1=[0.0570000000000000,0.132000000000000,0.0310000000000000,0.171000000000000,0.0220000000000000,0.0250000000000000,0.0220000000000000,0.158000000000000,0.162000000000000,0.0298000000000000,0.0750000000000000,0.0420000000000000,0.0335000000000000,0.0279000000000000,0.0553000000000000,0.200000000000000,0.0480000000000000,0.263000000000000,0.0250000000000000];
CLu=[0,0,0,0,0.0840000000000000,0.132000000000000,0,0,0.0270000000000000,0.0200000000000000,0,0,0.400000000000000,0.280000000000000,-0.200000000000000,0,-0.180000000000000,-0.220000000000000,0.130000000000000];
CLa_dot=[1.70000000000000,1.70000000000000,5.30000000000000,4.10000000000000,4.20000000000000,4.20000000000000,1.80000000000000,1.80000000000000,2.70000000000000,2.50000000000000,3.30000000000000,2.70000000000000,2.20000000000000,2.20000000000000,0.820000000000000,0.630000000000000,0.170000000000000,6.70000000000000,7];
a1=[5.40000000000000,4,0,6.60000000000000,0,0,0.700000000000000,4.20000000000000,3.50000000000000,0,5,0,2.70000000000000,1.50000000000000,2,11.7000000000000,3.30000000000000,8.50000000000000,2.50000000000000];
Cm1=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
Cma_dot=[-5.57000000000000,-5.40000000000000,-12.7000000000000,-11.4000000000000,-9.60000000000000,-9.60000000000000,-6.64000000000000,-6.84000000000000,-9.10000000000000,-9.10000000000000,-10.3000000000000,-8.17000000000000,-6.70000000000000,-6.70000000000000,-2.05000000000000,-0.950000000000000,-0.250000000000000,-3.30000000000000,-4];
Cyp=[-0.145000000000000,-0.213000000000000,-0.141000000000000,-0.289700000000000,-0.140000000000000,-0.120000000000000,-0.0635000000000000,-0.190800000000000,-0.210000000000000,-0.190000000000000,-0.315000000000000,-0.227000000000000,0,0,0,0,0,0,0];
Cy_da=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0355000000000000,-0.0100000000000000,0,0];
Cy_dr=[0.187000000000000,0.187000000000000,0.230000000000000,0.230000000000000,0.0280000000000000,0.0280000000000000,0.200000000000000,0.200000000000000,0.144000000000000,0.148000000000000,0.200000000000000,0.200000000000000,0.140000000000000,0.140000000000000,0.0870000000000000,0.124000000000000,0.0500000000000000,0.179000000000000,0.120000000000000];
Cl_da=[0.229000000000000,0.229000000000000,0.172000000000000,0.172000000000000,0.100000000000000,0.100000000000000,0.178800000000000,0.178800000000000,0.156000000000000,0.156000000000000,0.177600000000000,0.177600000000000,0.178000000000000,0.178000000000000,0.0173000000000000,0.0570000000000000,0.0150000000000000,0.0530000000000000,0.0130000000000000];
Cl_dr=[0.0147000000000000,0.0147000000000000,0.0192000000000000,0.0192000000000000,0.0500000000000000,0.0500000000000000,0.0150000000000000,0.0150000000000000,0.00870000000000000,0.0109000000000000,0.0200000000000000,0.0200000000000000,0.0190000000000000,0.0210000000000000,0.00790000000000000,0.000900000000000000,0.00300000000000000,0,0.00800000000000000];
Cnp=[-0.0649000000000000,-0.0960000000000000,-0.0257000000000000,-0.102100000000000,0.0900000000000000,0.0800000000000000,-0.0154000000000000,-0.0768000000000000,-0.00500000000000000,0.0190000000000000,-0.0924000000000000,-0.0501000000000000,-0.00800000000000000,-0.0220000000000000,-0.0930000000000000,0.0130000000000000,0,-0.222000000000000,-0.0260000000000000];
Cn_da=[-0.0504000000000000,-0.0786000000000000,-0.0168000000000000,-0.0676000000000000,-0.00300000000000000,-0.00500000000000000,-0.0160000000000000,-0.0760000000000000,-0.00120000000000000,-0.00120000000000000,-0.0367000000000000,-0.0194000000000000,-0.0200000000000000,-0.0200000000000000,0.00250000000000000,0.00410000000000000,-0.000900000000000000,0.00830000000000000,0.00180000000000000];
Cn_dr=[-0.0805000000000000,-0.0604000000000000,-0.115200000000000,-0.115200000000000,-0.120000000000000,-0.120000000000000,-0.0365000000000000,-0.0365000000000000,-0.0763000000000000,-0.0772000000000000,-0.105400000000000,-0.105400000000000,-0.0740000000000000,-0.0740000000000000,-0.0435000000000000,-0.0720000000000000,-0.0250000000000000,-0.113000000000000,-0.100000000000000];
Cntb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
Cmtu=[0,0,0,0,0,0,0,0,0,0,0,0,-0.00300000000000000,-0.00300000000000000,0,0,0,0,0];
Cmt1=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
% inputs
m=W(i)/g;
% X
Xu= -q(i)*S(i)*(CDu(i)+CD1(i))/(m*U1(i));
Xa= -q(i)*S(i)*(CDa(i)+CL1(i))/(m*U1(i));
X_de= -q(i)*S(i)*(CD_de(i))/(m);
Xtu=-q(i)*S(i)*(Ctxu(i)+Ctx1(i))/(m*U1(i));
% Z
Zu= -q(i)*S(i)*(CLu(i)+CL1(i))/(m*U1(i));
Za= -q(i)*S(i)*(CLa(i)+CD1(i))/(m*U1(i));
Z_de= -q(i)*S(i)*(CL_de(i))/(m);
Zq=-q(i)*S(i)*c(i)*(CLq(i))/(2*m*U1(i));
Za_dot=-q(i)*S(i)*c(i)*(CLa_dot(i))/(2*m*U1(i));
% M
Mu= q(i)*S(i)*c(i)*(Cmu(i)+2*Cm1(i))/(2*Iyy(i)*U1(i));
Ma= q(i)*S(i)*c(i)*(Cma(i))/(Iyy(i));
M_de= q(i)*S(i)*c(i)*(Cm_de(i))/(Iyy(i));
Mq= q(i)*S(i)*c(i)^2*(Cmq(i))/(2*Iyy(i)*U1(i));
Ma_dot=q(i)*S(i)*c(i)^2*(Cma_dot(i))/(2*Iyy(i)*U1(i));
Mtu=q(i)*S(i)*c(i)*(Cmtu(i)+2*Cmt1(i))/(Iyy(i)*U1(i));
%
A11=[cosd(a1(i))^2 sind(a1(i))^2 -sind(2*a1(i));
     sind(a1(i))^2 cosd(a1(i))^2 sind(2*a1(i));
     0.5*sind(2*a1(i)) -0.5*sind(2*a1(i)) cosd(2*a1(i))]*[Ixx(i);Izz(i);Ixz(i)];
Ixx=A11(1);Izz=A11(2);Ixz=A11(3);
% Y
Yb= q(i)*S(i)*(Cyb(i))/(m);
Yr= q(i)*S(i)*b(i)*(Cyr(i))/(2*m*U1(i));
Yp= q(i)*S(i)*b(i)*(Cyp(i))/(2*m*U1(i));
Y_da= q(i)*S(i)*(Cy_da(i))/(m);
Y_dr= q(i)*S(i)*(Cy_dr(i))/(m);
% L
Lb= q(i)*S(i)*b(i)*(Clb(i))/(Ixx);
Lr= q(i)*S(i)*b(i)^2*(Clr(i))/(2*Ixx*U1(i));
Lp= q(i)*S(i)*b(i)^2*(Clp(i))/(2*Ixx*U1(i));
L_da= q(i)*S(i)*b(i)*(Cl_da(i))/(Ixx);
L_dr= q(i)*S(i)*b(i)*(Cl_dr(i))/(Ixx);
% N
Nb= q(i)*S(i)*b(i)*(Cnb(i))/(Izz);
Nr= q(i)*S(i)*b(i)^2*(Cnr(i))/(2*Izz*U1(i));
Np= q(i)*S(i)*b(i)^2*(Cnp(i))/(2*Izz*U1(i));
N_da= q(i)*S(i)*b(i)*(Cn_da(i))/(Izz);
N_dr= q(i)*S(i)*b(i)*(Cn_dr(i))/(Izz);
Ntb= q(i)*S(i)*b(i)*(Cntb(i))/(Izz);
A1=Ixz/Ixx;B1=Ixz/Izz;
% Calculations
%Approximations
%Short Period
wn_sp=sqrt(Za*Mq/U1(i)-Ma);
zita_sp=-(Mq+Za/U1(i)+Ma_dot)/(2*wn_sp);
%Phugoid
wn_ph=sqrt(-g*Zu/U1(i));
%wn_ph=g*sqrt(2)/U1;
zita_ph=-Xu/(2*wn_ph);
% zita_ph=sqrt(2)*(CDu(i)-Ctxu(i))/(4*CL1(i));
%zita_ph=sqrt(2)/(2*CL1/CD1)
%Dutch Roll
wn_d=sqrt(Nb+(Yb*Nr-Nb*Yr)/U1(i));
zita_d=-(Nr+Yb/U1(i))/(2*wn_d);
% Spiral
pole=(Lb*Nr-Nb*Lr)/(Lb+Nb*A1);
T_s=-1/pole;
% Roll
T_r=-1/Lp;

%Accurate
syms s
theta1=0;
%Longitudinal
A=[(s-Xu-Xtu) -Xa g*cosd(theta1);
   -Zu s*(U1(i)-Za_dot)-Za -(Zq+U1(i))*s+g*sind(theta1);
   -(Mu+Mtu) -(Ma_dot*s+Ma) s^2-Mq*s];
D=det(A);
roots_Long=double(root(D))
wn_Long(1)=double(norm(roots_Long(1)))
wn_Long(2)=double(norm(roots_Long(2)))
wn_Long(3)=double(norm(roots_Long(3)))
wn_Long(4)=double(norm(roots_Long(4)))
 zita_Long=-double(cos(angle(roots_Long)))

% Lateral Directional
A=[s*U1(i)-Yb -(g*cosd(theta1)+s*Yp) s*(U1(i)-Yr);
   -Lb s^2-Lp*s -(s^2*A1+s*Lr);
   -(Nb+Ntb) -(s^2*B1+Np*s) s^2-Nr*s]
D=det(A);
roots_Lat=double(root(D))
%  wn_Lat=double(norm(roots_Lat))
 wn_Lat(1)=double(norm(roots_Lat(1)))
 wn_Lat(2)=double(norm(roots_Lat(2)))
 wn_Lat(3)=double(norm(roots_Lat(3)))
 wn_Lat(4)=double(norm(roots_Lat(4)))

 zita_Lat=-double(cos(angle(roots_Lat)))



%% 9
% Calculations
%Longitudinal
syms s
i=18
A=[(s-Xu-Xtu) -Xa g*cosd(theta1);
   -Zu s*(U1(i)-Za_dot)-Za -(Zq+U1(i))*s+g*sind(theta1);
   -(Mu+Mtu) -(Ma_dot*s+Ma) s^2-Mq*s];
B=[X_de Z_de M_de]';
TrnferFcn_Long=(A^-1)*B;%TrnferFcn=[u/de a/de theta/de]'
[n,d] = numden(TrnferFcn_Long);
% 
n1=double(coeffs(n(1)));
d1=double(coeffs(d(1)));
u_def=tf(n1,d1)
n1=double(coeffs(n(2)));
d1=double(coeffs(d(2)));
a_def=tf(n1,d1)
n1=double(coeffs(n(3)));
d1=double(coeffs(d(3)));
theta_def=tf(n1,d1)
s=tf('s');
q_def=theta_def*s
% Lateral Directional
syms s
A=[s*U1(i)-Yb -(g*cosd(theta1)+s*Yp) s*(U1(i)-Yr);
   -Lb s^2-Lp*s -(s^2*A1+s*Lr);
   -(Nb+Ntb) -(s^2*B1+Np*s) s^2-Nr*s];
B=[Y_da L_da N_da]';
%B=[Y_dr L_dr N_dr]';
TrnferFcn_Lat=(A^-1)*B;%TrnferFcn=[b/di phi/di psi/di]'
[n,d] = numden(TrnferFcn_Lat);
n1=double(coeffs(n(1)));
d1=double(coeffs(d(1)));
b_da=tf(n1,d1)
n1=double(coeffs(n(2)));
d1=double(coeffs(d(2)));
phi_da=tf(n1,d1)
s=tf('s');
p_da=phi_da*s
syms s
n1=double(coeffs(n(3)));
d1=double(coeffs(d(3)));
psi_da=tf(n1,d1)
s=tf('s');
r_da=psi_da*s

syms s
B=[Y_dr L_dr N_dr]';
TrnferFcn_Lat=(A^-1)*B;%TrnferFcn=[b/di phi/di psi/di]'
[n,d] = numden(TrnferFcn_Lat);
n1=double(coeffs(n(1)));
d1=double(coeffs(d(1)));
b_dr=tf(n1,d1)
n1=double(coeffs(n(2)));
d1=double(coeffs(d(2)));
phi_dr=tf(n1,d1)
s=tf('s');
p_dr=phi_dr*s
syms s
n1=double(coeffs(n(3)));
d1=double(coeffs(d(3)));
psi_dr=tf(n1,d1)
s=tf('s');
r_dr=psi_dr*s


%% 10
% mode phugoid ra ba SAS nemitavn taghier dad
%Find Nr_Desired for Spiral and Dutch Roll
% pole=(Lb(i)*Nr(i)-Nb(i)*Lr(i))/(Lb(i)+Nb(i)*A1(i));
% T_s(i)=-1/pole;

Nr_Desired3=-1.1*zita_d*2*wn_d*U1(i)-Yb;
Nr_Desired2=(((Lb+Nb*A1)/(-1.4*T_s))+Nb*Lr)/Lb;
k2=Nr_Desired2-Nr/N_dr;
k3=Nr_Desired3-Nr/N_dr;

